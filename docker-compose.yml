services:
  # ── PostgreSQL 16 ──────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ai_fleet
      POSTGRES_USER: fleet
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fleet_dev_pw}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fleet -d ai_fleet"]
      interval: 5s
      timeout: 5s
      retries: 10
    profiles: [core]

  # ── Schema migrator (runs once, exits) ────────────────────────────────────
  migrator:
    image: postgres:16-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-fleet_dev_pw}
    command: >
      psql -h db -U fleet -d ai_fleet -f /migrations/0001_init.sql
    volumes:
      - ./db/migrations:/migrations:ro
    profiles: [ops]

  # ── Seed data loader ──────────────────────────────────────────────────────
  seed-loader:
    image: postgres:16-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-fleet_dev_pw}
    command: >
      sh -c "
        for f in /seeds/*.sql; do
          echo \"Applying seed: $$f\";
          psql -h db -U fleet -d ai_fleet -f $$f;
        done
      "
    volumes:
      - ./db/seeds:/seeds:ro
    profiles: [ops]

  # ── API (Node.js + Express + WebSocket) ───────────────────────────────────
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://fleet:${POSTGRES_PASSWORD:-fleet_dev_pw}@db:5432/ai_fleet
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL:-deepseek-r1:8b}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-mxbai-embed-large:latest}
      PORT: 3001
      NODE_ENV: production
      CORS_ORIGIN: "*"
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3001/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles: [core]

  # ── Web (Next.js) ──────────────────────────────────────────────────────────
  web:
    build:
      context: apps/web
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3001
      NEXT_PUBLIC_WS_URL: ws://localhost:3001/ws
      PORT: 3000
    ports:
      - "3000:3000"
    profiles: [core]

  # ── Vehicle Emitters (live mode — scale as needed) ─────────────────────────
  vehicle-emitter:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 2000
      VEHICLE_ID: ${VEHICLE_ID:-00000000-0000-0000-0000-000000000001}
      VEHICLE_REG_NO: ${VEHICLE_REG_NO:-MH12AB1234}
    profiles: [live]

volumes:
  pgdata:
