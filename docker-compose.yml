services:
  # ── PostgreSQL 16 ──────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ai_fleet
      POSTGRES_USER: fleet
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fleet_dev_pw}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fleet -d ai_fleet"]
      interval: 5s
      timeout: 5s
      retries: 10
    profiles: [core, ops, live]

  # ── Schema migrator (runs once, exits) ────────────────────────────────────
  migrator:
    image: postgres:16-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-fleet_dev_pw}
    command: >
      sh -c "
        set -- /migrations/*.sql;
        if [ \"$$1\" = \"/migrations/*.sql\" ]; then
          echo \"No migration files found in /migrations; exiting.\";
          exit 1;
        fi;
        for f in \"$$@\"; do
          echo \"Applying migration: $$f\";
          psql -v ON_ERROR_STOP=1 -h db -U fleet -d ai_fleet -f $$f;
        done
      "
    volumes:
      - ./db/migrations:/migrations:ro
    profiles: [ops]

  # ── Seed data loader ──────────────────────────────────────────────────────
  seed-loader:
    image: postgres:16-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-fleet_dev_pw}
    command: >
      sh -c "
        set -- /seeds/*.sql;
        if [ \"$$1\" = \"/seeds/*.sql\" ]; then
          echo \"No seed files found in /seeds; skipping seed-loader.\";
          exit 0;
        fi;
        for f in \"$$@\"; do
          echo \"Applying seed: $$f\";
          psql -v ON_ERROR_STOP=1 -h db -U fleet -d ai_fleet -f $$f;
        done
      "
    volumes:
      - ./db/seeds:/seeds:ro
    profiles: [ops]

  # ── Neo4j 5 Graph Database ──────────────────────────────────────────────
  neo4j:
    image: neo4j:5.15-community
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/password}
      NEO4J_server_memory_heap_max__size: 512m
      NEO4J_server_memory_pagecache_size: 256m
      NEO4J_PLUGINS: '["apoc"]'
    volumes:
      - neo4j_data:/data
    ports:
      - "7687:7687"   # Bolt (driver protocol)
      - "7474:7474"   # HTTP browser UI
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:7474"]
      interval: 10s
      timeout: 10s
      retries: 12
    networks:
      - ai-fleet
    profiles: [core, ops, live]

  # ── API (Node.js + Express + WebSocket) ───────────────────────────────────
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://fleet:${POSTGRES_PASSWORD:-fleet_dev_pw}@db:5432/ai_fleet
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL:-deepseek-r1:8b}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-mxbai-embed-large:latest}
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD_GRAPH:-password}
      PORT: 3001
      NODE_ENV: production
      CORS_ORIGIN: "*"
    ports:
      - "3001:3001"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:3001/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles: [core, live]

  # ── Web (Next.js) ──────────────────────────────────────────────────────────
  web:
    build:
      context: apps/web
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3001
      NEXT_PUBLIC_WS_URL: ws://localhost:3001/ws
      PORT: 3000
    ports:
      - "3000:3000"
    profiles: [core]

  # ── Vehicle Emitters (live mode — 14 vehicles) ─────────────────────────────
  # Mumbai fleet (veh-mum-01 to veh-mum-08)
  vehicle-emitter-mum-01:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-01
      VEHICLE_REG_NO: MH04AB1001
      START_LAT: "19.076"
      START_LNG: "72.877"
    profiles: [live]

  vehicle-emitter-mum-02:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-02
      VEHICLE_REG_NO: MH04AB1002
      START_LAT: "19.120"
      START_LNG: "72.910"
    profiles: [live]

  vehicle-emitter-mum-03:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-03
      VEHICLE_REG_NO: MH04AB1003
      START_LAT: "18.960"
      START_LNG: "72.820"
    profiles: [live]

  vehicle-emitter-mum-04:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-04
      VEHICLE_REG_NO: MH04CD2001
      START_LAT: "19.200"
      START_LNG: "72.980"
    profiles: [live]

  vehicle-emitter-mum-05:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-05
      VEHICLE_REG_NO: MH04CD2002
      START_LAT: "19.040"
      START_LNG: "72.850"
    profiles: [live]

  vehicle-emitter-mum-06:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-06
      VEHICLE_REG_NO: MH04CD2003
      START_LAT: "18.920"
      START_LNG: "72.840"
    profiles: [live]

  vehicle-emitter-mum-07:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-07
      VEHICLE_REG_NO: MH04EF3001
      START_LAT: "19.150"
      START_LNG: "72.860"
    profiles: [live]

  vehicle-emitter-mum-08:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-mum-08
      VEHICLE_REG_NO: MH04EF3002
      START_LAT: "19.005"
      START_LNG: "72.935"
    profiles: [live]

  # Delhi fleet (veh-del-01 to veh-del-06)
  vehicle-emitter-del-01:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-del-01
      VEHICLE_REG_NO: DL05GH4001
      START_LAT: "28.613"
      START_LNG: "77.209"
    profiles: [live]

  vehicle-emitter-del-02:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-del-02
      VEHICLE_REG_NO: DL05GH4002
      START_LAT: "28.700"
      START_LNG: "77.100"
    profiles: [live]

  vehicle-emitter-del-03:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-del-03
      VEHICLE_REG_NO: DL05JK5001
      START_LAT: "28.450"
      START_LNG: "77.050"
    profiles: [live]

  vehicle-emitter-del-04:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-del-04
      VEHICLE_REG_NO: DL05JK5002
      START_LAT: "28.800"
      START_LNG: "77.300"
    profiles: [live]

  vehicle-emitter-del-05:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-del-05
      VEHICLE_REG_NO: DL05MN6001
      START_LAT: "28.550"
      START_LNG: "77.450"
    profiles: [live]

  vehicle-emitter-del-06:
    build:
      context: apps/vehicle-emitter
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://api:3001
      EMIT_INTERVAL_MS: 3000
      VEHICLE_ID: veh-del-06
      VEHICLE_REG_NO: DL05MN6002
      START_LAT: "28.900"
      START_LNG: "76.900"
    profiles: [live]

volumes:
  pgdata:
  neo4j_data:

networks:
  ai-fleet:
    driver: bridge
