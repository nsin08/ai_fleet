# Sprint 2026-W08

**Dates:** 2026-02-16 to 2026-02-22  
**Document Type:** Product Owner + Architect Implementation Plan  
**Program Horizon:** 4 sprints (W08-W11)

## Goals
- Deliver an implementation-ready plan to evolve AI Fleet from monitoring demo to operational fleet management product.
- Lock P0 scope, dependencies, and architecture decisions for execution.
- Define acceptance criteria and measurable outcomes for each work package.

## Product Outcomes (Business)
| Outcome | Current State | Target by W11 |
|---|---|---|
| Dispatch visibility | Map and telemetry only | End-to-end trip lifecycle with assignment and exceptions |
| Alert handling efficiency | Ack/close only | Owner assignment, SLA timers, escalation, closure reasons |
| Maintenance control | Alert-driven only | Preventive schedule plus work order workflow |
| Cost control | No cost KPIs | Fuel anomaly workflow plus cost-per-km dashboards |
| Operational reporting | Basic views | Daily ops reports and export-ready tables |

## Scope
### P0 In Scope (W08-W11)
- Dispatch and trip execution.
- Driver operations.
- Maintenance operations.
- Fuel and cost management.
- Alert operations hardening.
- Reporting foundation.
- AI copilot UI integration.
- RBAC baseline and audit logs.

### P1 Deferred
- External ERP/TMS integrations.
- Mobile app for drivers.
- Advanced optimization (route optimization, predictive ETA model).

## Architecture Strategy
### System Boundaries
- Keep current stack and architecture:
  - Frontend: Next.js (`apps/web`)
  - API: Express (`apps/api`)
  - Data: PostgreSQL (`db/migrations`, `db/seeds`)
  - Domain core: `packages/domain`
  - Adapters: `packages/adapters`
- Extend by bounded modules rather than cross-cutting ad hoc features.

### Target Modules
| Module | Responsibility | Primary Surfaces |
|---|---|---|
| Dispatch | Trip planning, assignment, lifecycle, ETA/SLA, exceptions | `/dispatch`, `/trips/:id` |
| Driver Ops | Driver profile, availability, score, incidents | `/drivers`, `/drivers/:id` |
| Maintenance | PM policy, work orders, downtime states | `/maintenance`, `/maintenance/work-orders/:id` |
| Fuel and Cost | Fuel anomalies, trend and cost analytics | `/costs`, `/fuel` |
| Alert Ops | Ownership, SLA, escalation and closure governance | `/alerts` |
| Reporting | Daily/weekly operational reports and export | `/reports` |
| Access and Audit | Roles, permissions, audit trail | `/admin` |

### Data Model Additions (Proposed)
| Table | Purpose | Key Columns |
|---|---|---|
| `users` | Operator identities | `id`, `email`, `display_name`, `is_active` |
| `roles` | Role definitions | `id`, `name`, `permissions_json` |
| `user_roles` | User-role mapping | `user_id`, `role_id` |
| `trip_assignments` | Assignment metadata | `trip_id`, `dispatcher_id`, `assigned_at`, `status` |
| `trip_exceptions` | SLA/off-route/late events | `trip_id`, `type`, `severity`, `opened_at`, `closed_at` |
| `maintenance_plans` | PM schedule policy | `vehicle_id`, `interval_km`, `interval_days`, `next_due_*` |
| `work_orders` | Maintenance execution workflow | `id`, `vehicle_id`, `priority`, `status`, `opened_at`, `closed_at` |
| `fuel_events` | Fuel consumption/anomaly records | `vehicle_id`, `trip_id`, `event_type`, `fuel_delta_pct`, `ts` |
| `cost_entries` | Opex for reporting | `vehicle_id`, `trip_id`, `cost_type`, `amount`, `ts` |
| `alert_assignments` | Alert ownership and SLA | `alert_id`, `owner_user_id`, `sla_due_ts`, `escalation_level` |
| `audit_logs` | Compliance and traceability | `actor_id`, `action`, `entity_type`, `entity_id`, `payload`, `ts` |

## Implementation Work Packages
### WP-01 Dispatch and Trip Execution (P0)
**User Stories**
- As a dispatcher, I can create and assign trips to a vehicle and driver.
- As operations, I can track trip states (`planned`, `active`, `paused`, `completed`, `cancelled`) with exceptions.

**Acceptance Criteria**
- Trip create/edit/assign APIs and UI are available.
- State transitions are validated server-side.
- Trip timeline includes planned vs actual and exception events.
- ETA and delay reason fields are visible in list and details.

**Technical Tasks**
- DB: add `trip_assignments`, `trip_exceptions`.
- API: add `/api/dispatch/trips` CRUD plus transition endpoints.
- Web: add `/dispatch` board and trip detail page.
- Tests: route validation, transition guards, UI flow test.

### WP-02 Driver Operations (P0)
**User Stories**
- As fleet owner, I can view driver performance and incident history.
- As dispatcher, I can see driver availability before assignment.

**Acceptance Criteria**
- Driver list supports status and risk filters.
- Driver profile shows score trend and recent alerts/events.
- Assignment workflow blocks unavailable drivers.

**Technical Tasks**
- DB: add availability fields and optional shift windows.
- API: add `/api/drivers`, `/api/drivers/:id`, `/api/drivers/:id/score`.
- Web: add drivers list and profile pages.

### WP-03 Maintenance Operations (P0)
**User Stories**
- As maintenance lead, I can create and track work orders.
- As fleet owner, I can see vehicle downtime and PM due windows.

**Acceptance Criteria**
- Work order lifecycle: `OPEN -> IN_PROGRESS -> RESOLVED -> CLOSED`.
- Vehicle can be marked unavailable while work order is open.
- PM due list is visible by urgency.

**Technical Tasks**
- DB: add `maintenance_plans`, `work_orders`.
- API: add `/api/maintenance/plans`, `/api/maintenance/work-orders`.
- Web: add maintenance dashboard and work order details.

### WP-04 Fuel and Cost Management (P0)
**User Stories**
- As operations, I can identify fuel anomaly vehicles quickly.
- As fleet owner, I can track cost per km by vehicle/depot.

**Acceptance Criteria**
- Fuel anomaly list with evidence and disposition actions.
- Cost dashboard with date, depot, and vehicle filters.
- Cost per km and idle-cost KPIs rendered with trends.

**Technical Tasks**
- DB: add `fuel_events`, `cost_entries`.
- API: add `/api/fuel/anomalies`, `/api/costs/summary`, `/api/costs/by-vehicle`.
- Web: add fuel and costs pages.

### WP-05 Alert Ops Hardening (P0)
**User Stories**
- As safety officer, I can own alerts and meet SLA.
- As manager, I can monitor unresolved critical alerts.

**Acceptance Criteria**
- Alert owner, SLA due time, escalation state are visible.
- Bulk actions: assign, acknowledge, close.
- Closure requires a reason code.

**Technical Tasks**
- DB: add `alert_assignments` and closure reason enum.
- API: extend `/api/alerts/*` with assignment and bulk operations.
- Web: upgrade alerts table and detail drawer.

### WP-06 AI Copilot UI Integration (P0)
**User Stories**
- As operator, I can ask fleet questions from anywhere in UI.
- As manager, I get evidence-backed summaries for decisions.

**Acceptance Criteria**
- Global copilot drawer is available on all pages.
- Uses `/api/ai/chat`, `/api/ai/explain-alert`, `/api/ai/daily-summary`.
- Responses include references to vehicles/alerts/timestamps.

**Technical Tasks**
- Web: copilot shell component and context-aware prompts.
- API: enforce structured evidence payload format.

### WP-07 Reporting and Export (P0)
**User Stories**
- As fleet owner, I can get daily operations and exception reports.

**Acceptance Criteria**
- Reports page includes utilization, delays, alert burden, maintenance downtime.
- CSV export for core report tables.

**Technical Tasks**
- API: add `/api/reports/daily`, `/api/reports/exceptions`, `/api/reports/utilization`.
- Web: reports page with filters and export actions.

### WP-08 RBAC and Audit Foundation (P0)
**User Stories**
- As admin, I can control who can assign trips, close alerts, and close work orders.
- As auditor, I can trace critical actions.

**Acceptance Criteria**
- Role checks on mutation endpoints.
- Audit log entries for assignments, closures, and status transitions.
- Admin view for audit records.

**Technical Tasks**
- DB: add `users`, `roles`, `user_roles`, `audit_logs`.
- API middleware: auth context plus permission checks.
- Web: minimal admin panel and denied-action UX.

## Sprint-by-Sprint Delivery Plan
| Sprint | Focus | Exit Criteria |
|---|---|---|
| W08 | Foundation and dispatch MVP | DB migrations for core modules, dispatch APIs, dispatch read/write UI, initial AC tests |
| W09 | Driver plus maintenance | Driver pages, work order lifecycle, PM due board, integration tests |
| W10 | Fuel/cost plus alert hardening plus reports | Cost/fuel dashboards, alert ownership/SLA/escalation, report APIs/UI |
| W11 | Copilot plus RBAC/audit plus stabilization | Copilot drawer live, role checks active, audit log UI, UAT pass and demo script ready |

## Engineering Breakdown (Execution Ready)
### Backend
- Add migration set:
  - `0002_dispatch.sql`
  - `0003_maintenance.sql`
  - `0004_costs.sql`
  - `0005_access_audit.sql`
- Add controllers by module:
  - `dispatch.controller.ts`
  - `drivers.controller.ts`
  - `maintenance.controller.ts`
  - `costs.controller.ts`
  - `reports.controller.ts`
  - `admin.controller.ts`
- Add repository adapters for new tables.
- Expand rule engine and event normalization.

### Frontend
- Extend nav with `Dispatch`, `Drivers`, `Maintenance`, `Costs`, `Reports`, `Admin`.
- Add module pages with SWR data hooks and shared table/filter components.
- Add global copilot drawer integrated in `layout.tsx`.

### Quality and Verification
- API contract tests for each new endpoint.
- UI smoke tests for critical flows:
  - trip assignment
  - alert owner plus close
  - work order open/close
  - report export
- Data consistency checks:
  - status coherence between `vehicles` and `vehicle_latest_state`
  - trip state plus telemetry alignment

## Definition of Done (Per Work Package)
- Product acceptance criteria met.
- API endpoints documented and tested.
- UI implemented with empty/loading/error states.
- Migrations and seed data verified in docker compose flow.
- Observability added for key failures (API errors, WS stream errors, rule engine exceptions).

## Risks and Mitigations
| Risk | Impact | Mitigation |
|---|---|---|
| Scope overload across one sprint | High | Execute via 4-sprint staged plan with strict P0 gate |
| Data model churn | High | Lock schema per sprint and avoid breaking changes mid-sprint |
| UI complexity and inconsistency | Medium | Introduce shared UI primitives and page templates |
| Demo trust issues due unrealistic replay | Medium | Upgrade replay constraints and enforce coherent state transitions |
| Security delayed too late | High | Start RBAC foundation in parallel from W08 |

## Metrics
- Velocity: track per sprint (target >= 30 points per sprint after W08).
- Bugs found: severity split and reopen rate.
- Average cycle time: target <= 3 days per story after W09.
- Operational KPIs:
  - Alert acknowledge median time.
  - Trip on-time completion rate.
  - PM compliance rate.
  - Fuel anomaly resolution time.

## Immediate Next Actions (W08 Start)
1. Break WP-01 to WP-08 into GitHub issues with acceptance criteria from this document.
2. Create migration skeletons for dispatch, maintenance, costs, access, and audit.
3. Implement dispatch API plus UI first vertical slice and demo it end-to-end.

## Success Criteria Checklist (Update After Every Step)
**Instructions**
- Update this checklist immediately after completing each step.
- Mark completed items with `[x]`.
- Add evidence links (PR, commit, test run, screenshots) inline next to the item.
- Do not move to the next work package until all gate checks are complete.

### Global Delivery Gates (Apply to Every Work Package)
- [ ] Product acceptance criteria validated with stakeholder walkthrough.
- [x] DB migration applied successfully in local docker compose flow. (Evidence: `docker compose --profile ops run --rm migrator`, `0001_init.sql` + `0002_dispatch.sql` + `0003_driver_ops.sql` + `0004_maintenance.sql` + `0005_fuel_costs.sql` + `0006_alert_ops.sql` + `0007_access_audit.sql` applied)
- [x] API contract tests added and passing. (Evidence: `npm run test --workspace=apps/api`, 61/61 passing)
- [ ] UI state coverage verified (`loading`, `empty`, `error`, `success`).
- [ ] End-to-end happy-path manually verified.
- [ ] Regression checks completed for impacted existing pages.
- [ ] Observability/logging added for failure paths.
- [ ] Documentation updated (API, runbook, sprint notes).

### WP-01 Dispatch and Trip Execution
- [x] Schema: `trip_assignments` migration implemented. (Evidence: `db/migrations/0002_dispatch.sql`)
- [x] Schema: `trip_exceptions` migration implemented. (Evidence: `db/migrations/0002_dispatch.sql`)
- [x] API: trip CRUD endpoints delivered. (Evidence: `/api/dispatch/trips`, `/api/dispatch/trips/:tripId`, `/api/dispatch/trips/:tripId/assign`)
- [x] API: trip state-transition endpoints delivered. (Evidence: `/api/dispatch/trips/:tripId/transition`)
- [x] UI: `/dispatch` board delivered. (Evidence: `apps/web/src/app/dispatch/page.tsx`)
- [x] UI: trip detail page with timeline delivered. (Evidence: `apps/web/src/app/dispatch/trips/[tripId]/page.tsx`)
- [x] AC: state transitions server-validated. (Evidence: invalid transition returns 409)
- [x] AC: planned vs actual route and exceptions visible. (Evidence: stops timeline + planned/actual metrics in dispatch detail page)
- [x] AC: ETA and delay reason visible in list/detail. (Evidence: `plannedEtaAt` + `delayReason` in dispatch API and UI columns/cards)
- [x] Tests: transition guard tests passing. (Evidence: `Dispatch routes` test block)

### WP-02 Driver Operations
- [x] Schema: driver availability/shift fields added. (Evidence: `db/migrations/0003_driver_ops.sql`)
- [x] API: `/api/drivers` list endpoint delivered. (Evidence: `apps/api/src/controllers/drivers.controller.ts`)
- [x] API: `/api/drivers/:id` profile endpoint delivered. (Evidence: `apps/api/src/controllers/drivers.controller.ts`)
- [x] API: `/api/drivers/:id/score` endpoint delivered. (Evidence: `apps/api/src/controllers/drivers.controller.ts`)
- [x] UI: drivers list page delivered. (Evidence: `apps/web/src/app/drivers/page.tsx`)
- [x] UI: driver profile page delivered. (Evidence: `apps/web/src/app/drivers/[driverId]/page.tsx`)
- [x] AC: risk/status filters functional. (Evidence: `/drivers` filter chips + `/api/drivers?availability=&risk=` query support)
- [x] AC: availability check blocks invalid assignment. (Evidence: dispatch create/assign returns 409 for unavailable driver)
- [x] Tests: driver API and filter behavior passing. (Evidence: `Driver routes` + unavailable-driver dispatch test in `apps/api/src/__tests__/controllers.test.ts`)

### WP-03 Maintenance Operations
- [x] Schema: `maintenance_plans` migration implemented. (Evidence: `db/migrations/0004_maintenance.sql`)
- [x] Schema: `work_orders` migration implemented. (Evidence: `db/migrations/0004_maintenance.sql`)
- [x] API: maintenance plans endpoints delivered. (Evidence: `/api/maintenance/plans` GET/POST in `apps/api/src/controllers/maintenance.controller.ts`)
- [x] API: work order lifecycle endpoints delivered. (Evidence: `/api/maintenance/work-orders`, `/api/maintenance/work-orders/:workOrderId`, `/api/maintenance/work-orders/:workOrderId/transition`)
- [x] UI: maintenance dashboard delivered. (Evidence: `apps/web/src/app/maintenance/page.tsx`)
- [x] UI: work order detail lifecycle actions delivered. (Evidence: `apps/web/src/app/maintenance/work-orders/[workOrderId]/page.tsx`)
- [x] AC: work order states enforce valid transitions. (Evidence: invalid transition returns 409 in `Maintenance routes` tests)
- [x] AC: vehicle unavailable flag tied to open work order. (Evidence: `syncVehicleMaintenanceState` updates vehicle status to `maintenance_due` for OPEN/IN_PROGRESS)
- [x] AC: PM due queue visible with urgency. (Evidence: urgency and due metrics rendered on `/maintenance`)
- [x] Tests: work order lifecycle tests passing. (Evidence: `Maintenance routes` block in `apps/api/src/__tests__/controllers.test.ts`)

### WP-04 Fuel and Cost Management
- [x] Schema: `fuel_events` migration implemented. (Evidence: `db/migrations/0005_fuel_costs.sql`)
- [x] Schema: `cost_entries` migration implemented. (Evidence: `db/migrations/0005_fuel_costs.sql`)
- [x] API: fuel anomalies endpoint delivered. (Evidence: `/api/fuel/anomalies` + `/api/fuel/anomalies/:eventId/disposition` in `apps/api/src/controllers/costs.controller.ts`)
- [x] API: cost summary endpoint delivered. (Evidence: `/api/costs/summary` in `apps/api/src/controllers/costs.controller.ts`)
- [x] API: cost by vehicle endpoint delivered. (Evidence: `/api/costs/by-vehicle` in `apps/api/src/controllers/costs.controller.ts`)
- [x] UI: fuel anomalies page delivered. (Evidence: `apps/web/src/app/fuel/page.tsx`)
- [x] UI: cost dashboard delivered. (Evidence: `apps/web/src/app/costs/page.tsx`)
- [x] AC: cost-per-km and idle-cost KPIs visible. (Evidence: KPI cards + trend on `/costs`)
- [x] AC: anomaly workflow supports evidence and disposition. (Evidence: evidence panel + disposition actions on `/fuel`)
- [x] Tests: cost/fuel endpoints and filters passing. (Evidence: `Fuel and cost routes` block in `apps/api/src/__tests__/controllers.test.ts`)

### WP-05 Alert Ops Hardening
- [x] Schema: `alert_assignments` migration implemented. (Evidence: `db/migrations/0006_alert_ops.sql`)
- [x] Schema: closure reason constraint/enum implemented. (Evidence: `closure_reason` checks in `db/migrations/0006_alert_ops.sql`)
- [x] API: alert owner assignment endpoint delivered. (Evidence: `/api/alerts/:alertId/assign` in `apps/api/src/controllers/alerts.controller.ts`)
- [x] API: alert bulk action endpoints delivered. (Evidence: `/api/alerts/bulk` in `apps/api/src/controllers/alerts.controller.ts`)
- [x] UI: owner/SLA/escalation columns delivered in alerts. (Evidence: `apps/web/src/app/alerts/page.tsx`)
- [x] UI: bulk action UX delivered. (Evidence: selection + bulk action toolbar in `apps/web/src/app/alerts/page.tsx`)
- [x] AC: closure reason mandatory on close. (Evidence: `POST /api/alerts/:alertId/close` + `POST /api/alerts/bulk` validation checks)
- [x] AC: SLA timer and escalation state visible. (Evidence: `escalationState` + `slaDueTs` rendered in alerts table/detail)
- [x] Tests: assignment, SLA, and closure validations passing. (Evidence: alert assignment/closure/bulk tests in `apps/api/src/__tests__/controllers.test.ts`)

### WP-06 AI Copilot UI Integration
- [x] UI: global copilot drawer component integrated in layout. (Evidence: `apps/web/src/components/copilot-drawer.tsx` + `apps/web/src/app/layout.tsx`)
- [x] API integration: chat endpoint wired. (Evidence: `/api/ai/chat` calls in `apps/web/src/components/copilot-drawer.tsx`)
- [x] API integration: explain-alert endpoint wired. (Evidence: alerts detail action in `apps/web/src/app/alerts/page.tsx`)
- [x] API integration: daily-summary endpoint wired. (Evidence: daily summary action in `apps/web/src/components/copilot-drawer.tsx`)
- [x] AC: responses include evidence references. (Evidence: structured `evidence.references` in `apps/api/src/controllers/ai.controller.ts`)
- [x] AC: context-aware prompts available by page/module. (Evidence: route-aware prompts in `apps/web/src/components/copilot-drawer.tsx`)
- [x] Tests: copilot request/response and error handling passing. (Evidence: AI route tests in `apps/api/src/__tests__/controllers.test.ts`)

### WP-07 Reporting and Export
- [x] API: daily report endpoint delivered. (Evidence: `/api/reports/daily` in `apps/api/src/controllers/reports.controller.ts`)
- [x] API: exception report endpoint delivered. (Evidence: `/api/reports/exceptions` in `apps/api/src/controllers/reports.controller.ts`)
- [x] API: utilization report endpoint delivered. (Evidence: `/api/reports/utilization` in `apps/api/src/controllers/reports.controller.ts`)
- [x] UI: reports page with filters delivered. (Evidence: `apps/web/src/app/reports/page.tsx`)
- [x] UI: CSV export actions delivered. (Evidence: `exportUtilization` + `exportExceptions` in `apps/web/src/app/reports/page.tsx`)
- [x] AC: utilization, delay, alert burden, maintenance downtime visible. (Evidence: KPI cards bound to `/api/reports/daily.metrics` in `apps/web/src/app/reports/page.tsx`)
- [x] Tests: report filters and export behavior passing. (Evidence: `Reports routes` tests in `apps/api/src/__tests__/controllers.test.ts` and runtime checks for `/api/reports/*` on 2026-02-19)

### WP-08 RBAC and Audit Foundation
- [x] Schema: `users` migration implemented. (Evidence: `db/migrations/0007_access_audit.sql`)
- [x] Schema: `roles` migration implemented. (Evidence: `db/migrations/0007_access_audit.sql`)
- [x] Schema: `user_roles` migration implemented. (Evidence: `db/migrations/0007_access_audit.sql`)
- [x] Schema: `audit_logs` migration implemented. (Evidence: `db/migrations/0007_access_audit.sql`)
- [x] API: permission middleware delivered. (Evidence: `apps/api/src/middleware/rbac.ts`)
- [x] API: mutation endpoints protected with role checks. (Evidence: guarded mutation routes in `apps/api/src/controllers/dispatch.controller.ts`, `apps/api/src/controllers/alerts.controller.ts`, `apps/api/src/controllers/maintenance.controller.ts`, `apps/api/src/controllers/costs.controller.ts`, `apps/api/src/controllers/scenarios.controller.ts`)
- [x] UI: admin audit log view delivered. (Evidence: `apps/web/src/app/admin/page.tsx` + `/api/admin/users` + `/api/admin/audit-logs`)
- [x] AC: denied actions handled clearly in UI. (Evidence: `forbidden (<permission>)` surface in `apps/web/src/app/dispatch/page.tsx`, `apps/web/src/app/alerts/page.tsx`, `apps/web/src/app/maintenance/page.tsx`, `apps/web/src/app/fuel/page.tsx`)
- [x] AC: audit entries recorded for critical actions. (Evidence: runtime check `GET /api/admin/audit-logs?action=work_order.create&limit=1` returned `actorId=ops-admin`, `entityType=work_order`, `action=work_order.create` after mutation)
- [x] Tests: authorization and audit coverage passing. (Evidence: `RBAC and admin routes` tests in `apps/api/src/__tests__/controllers.test.ts`, 61/61 pass)

### Sprint Exit Checklist (W08-W11)
- [ ] W08 exit criteria met and signed off.
- [ ] W09 exit criteria met and signed off.
- [ ] W10 exit criteria met and signed off.
- [ ] W11 exit criteria met and signed off.
- [ ] Final UAT completed with fleet-owner scenario script.
- [ ] Production-readiness review completed (security, reliability, rollback).
