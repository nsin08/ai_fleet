# PR Validation - Enforce PR Hygiene Rules
# Reference: 20-rules/08-pr-hygiene.md
# Enforces: PR template, title format, issue linking, branch naming

name: "PR: Validation"

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  pr-title-format:
    name: Validate PR Title Format
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title matches pattern
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const titlePattern = /^(feat|fix|chore|docs|refactor|test|perf|style|ci|revert)\(.*\):|^(feat|fix|chore|docs|refactor|test|perf|style|ci|revert):/;
            
            if (!titlePattern.test(pr.title)) {
              core.setFailed(
                `❌ PR title must match format: "<type>(<scope>): <description>" or "<type>: <description>"
                
                Valid types: feat, fix, chore, docs, refactor, test, perf, style, ci, revert
                
                Examples:
                - feat(auth): Add login endpoint
                - fix: Resolve null pointer exception
                - docs: Update README
                
                Current title: "${pr.title}"`
              );
            } else {
              console.log(`✅ PR title format valid: ${pr.title}`);
            }

  pr-issue-link:
    name: Validate Issue Linking
    runs-on: ubuntu-latest
    steps:
      - name: Check PR closes exactly one issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title;
            
            // Match "Closes #123" or "Closes: #123" patterns
            const closesPattern = /^\s*(closes|closes|close|closes|fix|fixes|fixed|resolve|resolves|resolved)[:\s]+#(\d+)/mi;
            const matches = body.match(closesPattern) || title.match(closesPattern);
            
            if (!matches) {
              core.setFailed(
                `❌ PR must reference exactly one issue using "Closes #<issue-number>" in title or body
                
                Examples of valid formats:
                - Title: "feat: Add health endpoint (Closes #42)"
                - Body: "Closes #42"
                - Body: "This PR fixes #99"
                - Body: "Resolves: #15"
                
                See: 20-rules/04-artifact-linking.md`
              );
            } else {
              const issueNum = matches[2];
              console.log(`✅ PR links to issue #${issueNum}`);
            }

  pr-branch-naming:
    name: Validate Branch Naming
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name follows pattern
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            // Pattern: feature/123-description, fix/456-slug, chore/789-name, etc.
            const branchPattern = /^(feature|fix|chore|docs|refactor|test|hotfix)\/\d+-[a-z0-9-]+$/;
            
            if (!branchPattern.test(branch)) {
              core.setFailed(
                `❌ Branch name must follow pattern: <type>/<issue-id>-<slug>
                
                Valid types: feature, fix, chore, docs, refactor, test, hotfix
                
                Examples:
                - feature/42-health-endpoint
                - fix/99-null-pointer
                - chore/15-update-deps
                - docs/8-api-readme
                
                Current branch: "${branch}"
                See: 20-rules/07-branch-naming.md`
              );
            } else {
              console.log(`✅ Branch naming valid: ${branch}`);
            }

  pr-no-draft:
    name: Prevent Draft PRs from Merging
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == true
    steps:
      - name: Block draft PR
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed(
              `❌ Draft PRs cannot be merged
              
              Please mark as "Ready for review" before merging.
              
              Click "Ready for review" button in PR header.`
            );

  pr-template-filled:
    name: Validate PR Template Completion
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body filled
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Check for common template placeholders
            const placeholders = [
              '<!-- Add description -->',
              'TODO:',
              '...',
              '[DESCRIBE]',
              '[ADD DESCRIPTION]',
              'Add description here'
            ];
            
            const hasPlaceholder = placeholders.some(p => body.toLowerCase().includes(p.toLowerCase()));
            
            if (body.length < 20 || hasPlaceholder) {
              core.setFailed(
                `❌ PR description is incomplete or contains placeholders
                
                Please fill out the PR template completely:
                - Summary of changes
                - Link to Story/Issue (Closes #)
                - Test evidence
                - Documentation updates
                - Type of change (feat/fix/chore)
                
                See: .github/pull_request_template.md (install from 50-templates/05-pull-request.md)`);
            } else {
              console.log('✅ PR template adequately filled');
            }

  pr-no-wip:
    name: Block WIP PRs
    runs-on: ubuntu-latest
    steps:
      - name: Check for WIP markers in title
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const wipPatterns = [/^WIP:/i, /^\[WIP\]/i, /^\(WIP\)/i];
            
            if (wipPatterns.some(p => p.test(pr.title))) {
              core.setFailed(
                `❌ WIP (Work In Progress) PRs cannot be merged
                
                Please remove WIP marker when ready for review:
                - Remove "WIP:" prefix from title
                - Mark as "Ready for review" (not draft)
                - Add description of changes
                
                WIP PRs should be saved as drafts instead.`);
            } else {
              console.log('✅ Not a WIP PR');
            }
