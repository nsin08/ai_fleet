name: Security Gate

description: |
  Security scanning and validation before merge.
  Reference: 20-rules/03-definition-of-done.md

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          extra_args: --only-verified

      - name: Basic secret pattern check
        run: |
          echo "Checking for common secret patterns..."
          
          PATTERNS=(
            "api[_-]?key\s*[=:]\s*['\"][a-zA-Z0-9]{20,}['\"]"
            "secret\s*[=:]\s*['\"][a-zA-Z0-9]{20,}['\"]"
            "password\s*[=:]\s*['\"][^'\"]{8,}['\"]"
            "token\s*[=:]\s*['\"][a-zA-Z0-9]{20,}['\"]"
            "-----BEGIN.*PRIVATE KEY-----"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if git diff origin/main...HEAD 2>/dev/null | grep -iE "$pattern" > /dev/null 2>&1; then
              echo "⚠️ Potential secret detected matching pattern: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "::warning::Potential secrets detected. Please review."
          else
            echo "✅ No obvious secrets detected"
          fi

  dependency-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Detect package managers
        id: detect
        run: |
          if [ -f package.json ]; then
            echo "has_npm=true" >> $GITHUB_OUTPUT
          fi
          if [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "has_pip=true" >> $GITHUB_OUTPUT
          fi
          if [ -f go.mod ]; then
            echo "has_go=true" >> $GITHUB_OUTPUT
          fi

      - name: Run npm audit
        if: steps.detect.outputs.has_npm == 'true'
        run: |
          npm audit --audit-level=high || echo "::warning::npm audit found issues"
        continue-on-error: true

      - name: Run pip audit
        if: steps.detect.outputs.has_pip == 'true'
        run: |
          pip install pip-audit
          pip-audit || echo "::warning::pip-audit found issues"
        continue-on-error: true

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Check for debug statements
        run: |
          echo "Checking for debug statements..."
          
          DEBUG_PATTERNS="console\.log|debugger|print\(|pdb\.set_trace"
          
          if git diff origin/main...HEAD 2>/dev/null | grep -E "^\+.*($DEBUG_PATTERNS)" > /dev/null 2>&1; then
            echo "::warning::Debug statements found in diff"
          else
            echo "✅ No debug statements in new code"
          fi

      - name: Check for TODOs in PR
        run: |
          echo "Checking for TODOs..."
          
          if git diff origin/main...HEAD 2>/dev/null | grep -E "^\+.*(TODO|FIXME|XXX|HACK)" > /dev/null 2>&1; then
            echo "::notice::TODOs found in new code - ensure they are tracked as issues"
          fi
