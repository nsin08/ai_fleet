# Definition of Done (DoD) Enforcement
# Reference: 20-rules/03-definition-of-done.md
# Enforces: DoD checklist completion before PR merge

name: "PR: Definition of Done"

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-dod:
    name: Verify Definition of Done
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check DoD checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Check for DoD checklist
            const dodPattern = /## Definition of Done|## DoD/i;
            const checkboxPattern = /- \[([ x])\]/g;
            const checkboxes = body.match(checkboxPattern) || [];
            
            if (checkboxes.length === 0) {
              core.warning(
                `⚠️  No Definition of Done checklist found
                
                Add DoD checklist to PR body:
                
                ## Definition of Done
                - [ ] All acceptance criteria met with evidence
                - [ ] Tests added and passing
                - [ ] Documentation updated
                - [ ] PR template 100% filled
                - [ ] Reviewer approved
                - [ ] CI green
                - [ ] No regressions
                
                See: 20-rules/03-definition-of-done.md`);
              return;
            }
            
            const allChecked = checkboxes.every(box => box.includes('x') || box.includes('X'));
            const checked = checkboxes.filter(b => b.includes('x') || b.includes('X')).length;
            const total = checkboxes.length;
            
            if (!allChecked) {
              core.warning(
                `⚠️  Definition of Done incomplete: ${checked}/${total} items checked
                
                Please verify all DoD criteria before requesting merge:
                - [ ] Acceptance criteria met (with evidence)
                - [ ] Tests passing (local + CI)
                - [ ] Documentation updated
                - [ ] PR template complete
                - [ ] Reviewer approval
                - [ ] CI green
                - [ ] No regressions
                
                Current progress: ${Math.round(checked/total*100)}%`);
            } else {
              console.log(`✅ Definition of Done satisfied (${checked}/${total})`);
            }

      - name: Check evidence mapping
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Check for evidence table or mapping
            const hasEvidenceTable = body.includes('| Criterion') || body.includes('Evidence:');
            const hasCriteria = body.includes('Success Criteria') || body.includes('Acceptance Criteria');
            
            if (hasCriteria && !hasEvidenceTable) {
              core.warning(
                `⚠️  Success criteria found but no evidence mapping
                
                Map each criterion to test evidence:
                
                | Criterion | Status | Evidence |
                |-----------|--------|----------|
                | Returns 200 | ✅ | test_health_returns_200 (tests/health.py:L10-L15) PASSING |
                | Includes timestamp | ✅ | test_has_timestamp (tests/health.py:L20-L25) PASSING |
                
                See: 20-rules/03-definition-of-done.md`);
            } else if (hasEvidenceTable) {
              console.log('✅ Evidence mapping provided');
            }
